<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockCal - מערכת מחקר מניות</title>
    <link rel="stylesheet" href="/global.css">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- תפריט ניווט משופר -->
    <nav class="navbar" id="main-navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <a href="/" class="logo">StockCal <i class="fas fa-chart-line"></i></a>
            </div>
            <div class="navbar-links">
                <ul class="nav-menu" id="nav-menu">
                    <li class="nav-item"><a href="/index.html" class="nav-link active">עמוד הבית</a></li>
                    <li class="nav-item"><a href="/info.html" class="nav-link">מושגים</a></li>
                </ul>
            </div>
            <div class="theme-toggle-container">
                <button id="theme-toggle" class="theme-toggle" aria-label="החלפת מצב תצוגה">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
            <div class="hamburger" id="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- אזור החיפוש -->
    <header class="search-container">
        <h1>מערכת מחקר מניות</h1>
        <div class="search-box">
            <input type="text" id="stock-search" placeholder="הזן שם מניה או סמל לחיפוש...">
            <button id="search-button">חפש</button>
        </div>
    </header>

    <!-- אזור תצוגת מניה -->
    <section id="stock-display" class="stock-display">
        <div class="stock-info">
            <h2 id="stock-name">שם המניה</h2>
            <div class="stock-current-value">
                <span id="stock-value">0.00</span>
                <span id="stock-change">0.00 (0.00%)</span>
            </div>
        </div>
        
        <div class="stock-metrics">
            <div class="metric">
                <span class="metric-label">נפח מסחר</span>
                <span id="stock-volume" class="metric-value">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">מחזור</span>
                <span id="stock-turnover" class="metric-value">$0</span>
            </div>
            <div class="metric">
                <span class="metric-label">שווי שוק</span>
                <span id="stock-market-cap" class="metric-value">$0</span>
            </div>
            <div class="metric">
                <span class="metric-label">מכפיל רווח</span>
                <span id="stock-pe" class="metric-value">0</span>
            </div>
        </div>
        
        <div id="stock-chart-container" class="stock-chart-container">
            <div id="stock-chart">
                <!-- כאן יוצג הגרף -->
            </div>
        </div>
        
        <div class="chart-controls">
            <div class="range-selector">
                <button class="range-button active" data-range="1m">חודש</button>
                <button class="range-button" data-range="3m">3 חודשים</button>
                <button class="range-button" data-range="1y">שנה</button>
                <button class="range-button" data-range="5y">5 שנים</button>
            </div>
            <div class="chart-type-selector">
                <button class="chart-type-button active" data-type="line">קו</button>
                <button class="chart-type-button" data-type="candle">נרות</button>
                <button class="chart-type-button" data-type="ohlc">OHLC</button>
            </div>
        </div>
        
        <div class="last-update">
            עדכון אחרון: <span id="last-update-time">00:00</span>
        </div>
    </section>
    
    <!-- אזור חדשות -->
    <section class="news-container">
        <h2>חדשות ועדכונים</h2>
        <div class="news-tabs">
            <button class="tab-button active" data-source="all">הכל</button>
            <button class="tab-button" data-source="stockdata">StockData</button>
            <button class="tab-button" data-source="finnhub">Finnhub</button>
            <button class="tab-button" data-source="yahoo">Yahoo Finance</button>
        </div>
        
        <div id="news-all" class="news-tab active">
            <!-- כאן יוצגו חדשות משולבות -->
            <p>הזן שם מניה או סמל לחיפוש חדשות</p>
        </div>
        
        <div id="news-stockdata" class="news-tab">
            <!-- כאן יוצגו חדשות מ-StockData -->
        </div>
        
        <div id="news-finnhub" class="news-tab">
            <!-- כאן יוצגו חדשות מ-Finnhub -->
        </div>
        
        <div id="news-yahoo" class="news-tab">
            <!-- כאן יוצגו חדשות מ-Yahoo -->
        </div>
    </section>
    
    <!-- אזור המלצות אלגוריתמיות -->
    <section class="recommendations-container">
        <h2>המלצות אלגוריתמיות</h2>
        <div class="recommendations-tabs">
            <button class="tab-button active" data-budget="low">תקציב נמוך</button>
            <button class="tab-button" data-budget="high">תקציב גבוה</button>
        </div>
        
        <div id="low-budget" class="recommendations-tab active">
            <!-- כאן יוצגו המלצות לתקציב נמוך -->
            <p>טוען המלצות...</p>
        </div>
        
        <div id="high-budget" class="recommendations-tab">
            <!-- כאן יוצגו המלצות לתקציב גבוה -->
        </div>
    </section>
    
    <!-- אזור סננים -->
    <section class="filters-container">
        <h2>סננים אלגוריתמיים</h2>
        <div class="filters-tabs">
            <button class="tab-button active" data-filter="momentum">מומנטום</button>
            <button class="tab-button" data-filter="etf">ETF מינוף</button>
            <button class="tab-button" data-filter="technical">אינדיקטורים טכניים</button>
        </div>
        
        <div id="momentum-filter" class="filter-tab active">
            <div class="filter-params">
                <div class="param-group">
                    <label for="momentum-threshold">סף מומנטום (%)</label>
                    <input type="number" id="momentum-threshold" min="0" step="0.1" value="1.5">
                </div>
                <div class="param-group">
                    <label for="momentum-timeframe">תקופת זמן (ימים)</label>
                    <input type="number" id="momentum-timeframe" min="1" value="5">
                </div>
                <div class="param-group">
                    <label for="profit-target">יעד רווח (%)</label>
                    <input type="number" id="profit-target" min="0.1" step="0.1" value="2.0">
                </div>
            </div>
            <button id="apply-momentum" class="filter-button">הפעל סינון</button>
            <div id="momentum-results" class="filter-results">
                <!-- כאן יוצגו תוצאות הסינון -->
                <p>לחץ על "הפעל סינון" לחיפוש מניות עם מומנטום</p>
            </div>
        </div>
        
        <div id="etf-filter" class="filter-tab">
            <div class="filter-params">
                <div class="param-group">
                    <label for="etf-sector">סקטור</label>
                    <select id="etf-sector">
                        <option value="all">כל הסקטורים</option>
                        <option value="gold">זהב</option>
                        <option value="oil">נפט</option>
                        <option value="gas">גז טבעי</option>
                        <option value="semiconductor">מוליכים למחצה</option>
                        <option value="nasdaq">נאסדק</option>
                        <option value="sp500">S&P 500</option>
                    </select>
                </div>
                <div class="param-group">
                    <label for="mismatch-threshold">סף אי התאמה (%)</label>
                    <input type="number" id="mismatch-threshold" min="0.1" step="0.1" value="1.0">
                </div>
                <div class="param-group">
                    <label for="etf-direction">כיוון</label>
                    <select id="etf-direction">
                        <option value="both">שני הכיוונים</option>
                        <option value="up">עלייה בלבד</option>
                        <option value="down">ירידה בלבד</option>
                    </select>
                </div>
            </div>
            <button id="apply-etf" class="filter-button">הפעל סינון</button>
            <div id="etf-results" class="filter-results">
                <!-- כאן יוצגו תוצאות הסינון -->
                <p>לחץ על "הפעל סינון" לחיפוש אי התאמות בקרנות סל</p>
            </div>
        </div>
        
        <div id="technical-filter" class="filter-tab">
            <div class="filter-params">
                <div class="param-group">
                    <label for="technical-indicator">אינדיקטור</label>
                    <select id="technical-indicator">
                        <option value="rsi">RSI</option>
                        <option value="macd">MACD</option>
                        <option value="moving_avg">ממוצע נע</option>
                    </select>
                </div>
                <div class="param-group">
                    <label for="condition">תנאי</label>
                    <select id="condition">
                        <option value="oversold">קניית חסר (Oversold)</option>
                        <option value="overbought">קניית יתר (Overbought)</option>
                        <option value="crossing">חציית קווים (Crossing)</option>
                    </select>
                </div>
                <div class="param-group">
                    <label for="timeframe">מסגרת זמן</label>
                    <select id="timeframe">
                        <option value="daily">יומי</option>
                        <option value="weekly">שבועי</option>
                        <option value="monthly">חודשי</option>
                    </select>
                </div>
            </div>
            <button id="apply-technical" class="filter-button">הפעל סינון</button>
            <div id="technical-results" class="filter-results">
                <!-- כאן יוצגו תוצאות הסינון -->
                <p>לחץ על "הפעל סינון" לחיפוש מניות לפי אינדיקטורים טכניים</p>
            </div>
        </div>
    </section>
    
    <!-- בואו לחקור עוד -->
    <section class="explore-section">
        <div class="container">
            <h2 class="section-title">בואו לחקור עוד</h2>
            <div class="explore-grid">
                <a href="https://finance.yahoo.com" class="explore-card yahoo" target="_blank">
                    <div class="explore-icon"><i class="fas fa-chart-bar"></i></div>
                    <h3>Yahoo Finance</h3>
                    <p>נתוני עומק, חדשות ודיווחי חברות מהמקור המוביל למידע פיננסי</p>
                </a>
                
                <a href="https://www.tradingview.com" class="explore-card chatgpt" target="_blank">
                    <div class="explore-icon"><i class="fas fa-chart-line"></i></div>
                    <h3>TradingView</h3>
                    <p>כלי ניתוח טכני מתקדמים, גרפים מקצועיים וקהילת משקיעים פעילה</p>
                </a>
                
                <a href="https://www.investopedia.com" class="explore-card perplexity" target="_blank">
                    <div class="explore-icon"><i class="fas fa-graduation-cap"></i></div>
                    <h3>Investopedia</h3>
                    <p>מאמרים, הדרכות ומילון מושגים מקיף לכל רמות הידע בשוק ההון</p>
                </a>
            </div>
        </div>
    </section>

    <!-- פוטר -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <h3>StockCal <i class="fas fa-chart-line"></i></h3>
                <p>מערכת מחקר מניות מתקדמת</p>
            </div>
            <div class="footer-disclaimer">
                <h4>הצהרה</h4>
                <p>המידע המוצג באתר זה הוא למטרות מידע בלבד ואינו מהווה המלצה להשקעה. השקעה בשוק ההון כרוכה בסיכונים.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 StockCal. כל הזכויות שמורות.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <script src="/global.js"></script>
    <script src="/StockAPI.js"></script>
    <script src="/back.js"></script>
    
    <!-- תסריט עבור iframe של Stockdio -->
    <script>
    // עדכון פונקציית loadStockData כדי לשלב iframe ישירות
    function loadStockData(symbol) {
        // הצגת מחוון טעינה
        document.getElementById('stock-name').textContent = 'טוען...';

        try {
            // נרמול הסמל
            const normalizedSymbol = symbol.trim().toUpperCase();
            
            // יצירת iframe לגרף Stockdio
            const API_KEY = '7AE8EC3A9B0140D4835C74E5899E348F'; // החלף למפתח האמיתי שלך
            const iframeUrl = `https://api.stockdio.com/visualization/financial/charts/v1/HistoricalPrices?app-key=${API_KEY}&symbol=${normalizedSymbol}&dividends=true&splits=true&days=365`;
            
            // הוספת iframe לאזור הגרף
            const chartContainer = document.getElementById('stock-chart');
            chartContainer.innerHTML = `<iframe frameBorder="0" scrolling="no" width="100%" height="400" src="${iframeUrl}"></iframe>`;
            
            // נסיון להשיג נתונים נוספים על המניה
            document.getElementById('stock-name').textContent = normalizedSymbol;
            
            // שימוש ב-StockAPI לנסות לקבל מידע נוסף
            StockAPI.getStockData(normalizedSymbol)
            .then(stockData => {
                // עדכון פרטי המניה בממשק
                updateStockInfo(stockData);
            })
            .catch(error => {
                console.error('שגיאה בטעינת נתוני המניה:', error);
                // אם אין נתונים מפורטים, עדיין מציג את הגרף
                document.getElementById('stock-value').textContent = '0.00';
                document.getElementById('stock-change').textContent = '0.00 (0.00%)';
                document.getElementById('stock-change').className = 'neutral';
                document.getElementById('stock-volume').textContent = '0';
                document.getElementById('stock-turnover').textContent = '$0';
                document.getElementById('stock-market-cap').textContent = '$0';
                document.getElementById('stock-pe').textContent = '0';
            });
            
            // טעינת חדשות רלוונטיות
            loadNewsForStock(normalizedSymbol);
            
            // עדכון זמן עדכון אחרון
            updateLastUpdateTime();
        } catch (error) {
            console.error('שגיאה כללית:', error);
            document.getElementById('stock-name').textContent = 'שגיאה בטעינת נתוני המניה';
            document.getElementById('stock-chart').innerHTML = '<p>לא ניתן לטעון את הגרף</p>';
            showNotification(error.message, 'error');
        }
    }

    // עדכון פונקציית updateChartRange כדי לשנות את הימים בiframe
    function updateChartRange(range) {
        if (!currentStock) return;
        
        // המרת טווח לימים
        let days;
        switch (range) {
            case '1d': days = 1; break;
            case '5d': days = 5; break;
            case '1m': days = 30; break;
            case '3m': days = 90; break;
            case '1y': days = 365; break;
            case '5y': days = 1825; break;
            default: days = 30;
        }
        
        // עדכון iframe עם טווח הזמן החדש
        const API_KEY = '7AE8EC3A9B0140D4835C74E5899E348F'; // החלף למפתח האמיתי שלך
        const iframeUrl = `https://api.stockdio.com/visualization/financial/charts/v1/HistoricalPrices?app-key=${API_KEY}&symbol=${currentStock}&dividends=true&splits=true&days=${days}`;
        
        const chartContainer = document.getElementById('stock-chart');
        chartContainer.innerHTML = `<iframe frameBorder="0" scrolling="no" width="100%" height="400" src="${iframeUrl}"></iframe>`;
    }

    // עדכון פונקציית updateChartType כדי לשנות את סוג הגרף בiframe
    function updateChartType(type) {
        if (!currentStock) return;
        
        // המרת סוג הגרף לפרמטר המתאים
        let displayType;
        switch (type) {
            case 'candle': displayType = 'Candlestick'; break;
            case 'ohlc': displayType = 'OHLC'; break;
            case 'line':
            default: displayType = 'Line';
        }
        
        // קבלת מספר הימים הנוכחי מה-iframe
        const currentIframe = document.querySelector('#stock-chart iframe');
        if (!currentIframe) return;
        
        const currentSrc = currentIframe.src;
        const daysMatch = currentSrc.match(/days=(\d+)/);
        const days = daysMatch ? daysMatch[1] : '365';
        
        // עדכון iframe עם סוג הגרף החדש
        const API_KEY = '7AE8EC3A9B0140D4835C74E5899E348F'; // החלף למפתח האמיתי שלך
        const iframeUrl = `https://api.stockdio.com/visualization/financial/charts/v1/HistoricalPrices?app-key=${API_KEY}&symbol=${currentStock}&dividends=true&splits=true&days=${days}&displayPrices=${displayType}`;
        
        const chartContainer = document.getElementById('stock-chart');
        chartContainer.innerHTML = `<iframe frameBorder="0" scrolling="no" width="100%" height="400" src="${iframeUrl}"></iframe>`;
    }
    </script>
</body>
</html>